# https://taskfile.dev

version: '3'

vars:
  GREETING: Hello, World!

tasks:
  default:
    cmd: task --list
    silent: true
  # tests
  test-flux-local:
    cmds:
      - flux-local test --enable-helm
    sources:
      - cluster/**/*.yaml
  test-kubeconform:
    cmds:
      - ./scripts/kubeconform.sh
    sources:
      - cluster/**/*.yaml
  test-terraform:
    dir: terraform 
    cmds:
      - terraform -chdir=authentik init
      - terraform -chdir=authentik validate
      - terraform -chdir=proxmox init
      - terraform -chdir=proxmox validate
      - terraform -chdir=vault init
      - terraform -chdir=vault validate
    sources:
      - terraform/**/*.tf
      - terraform/**/*.tfvars
  test:
    deps:
      - test-flux-local
      - test-kubeconform
      - test-terraform
  deploy-infrastructure: 
    dir: terraform
    cmds:
      - terraform -chdir=proxmox init
      - terraform -chdir=proxmox apply -auto-approve
    sources:
      - terraform/proxmox/**/*.tf
      - terraform/proxmox/cluster/*
  deploy-fluxcd: 
    dir: cluster/bootstrap
    cmds:
      - flux bootstrap git --url=ssh://git@github.com/razelighter777/iaas.git --path=cluster/bootstrap --private-key-file=$HOME/.ssh/id_ed25519
    sources:
      - cluster/bootstrap/**/*.yaml
  deploy: 
    deps:
      - deploy-infrastructure
      - deploy-fluxcd