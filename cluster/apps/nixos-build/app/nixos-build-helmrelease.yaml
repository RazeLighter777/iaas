---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nixos-build
  namespace: nixos-build
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 4.0.1
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controllers:
      nixos-build:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          nix-seed:
            image:
              repository: ghcr.io/razelighter777/iaas/nixos-build-daemon
              tag: 0.0.4
            command:
              - /bin/sh
              - -c
              - |
                set -e
                if [ ! -d /mnt/nix/store ]; then
                  mkdir -p /mnt/nix
                  cp -a /nix/. /mnt/nix/
                fi
            securityContext:
              runAsUser: 0
              runAsGroup: 0
          nix-builds-perms:
            image:
              repository: busybox
              tag: 1.37.0
            command:
              - /bin/sh
              - -c
              - |
                set -e
                mkdir -p /nix/var/nix/builds
                chown root:root /nix/var/nix/builds
                chmod 0755 /nix/var/nix/builds
            securityContext:
              runAsUser: 0
              runAsGroup: 0
          ssh-perms:
            image:
              repository: busybox
              tag: 1.37.0
            command:
              - /bin/sh
              - -c
              - |
                set -e
                chown root:root /ssh
                chmod 0700 /ssh
            securityContext:
              runAsUser: 0
              runAsGroup: 0
        containers:
          daemon:
            image:
              repository: ghcr.io/razelighter777/iaas/nixos-build-daemon
              tag: 0.0.4
            command:
              - /usr/local/bin/start-nix-daemon.sh
            envFrom:
              - secretRef:
                  name: nixos-build-cache-keys
            securityContext:
              privileged: true
              allowPrivilegeEscalation: true
          ssh-gateway:
            image:
              repository: ghcr.io/razelighter777/iaas/nixos-build-ssh-gateway
              tag: 0.0.1
            command:
              - /nix/var/nix/profiles/default/bin/sshd
              - -D
              - -e
              - -f
              - /etc/ssh/sshd_config
            securityContext:
              privileged: true
    defaultPodOptions:
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0
    service:
      ssh:
        controller: nixos-build
        primary: true
        type: LoadBalancer
        loadBalancerIP: ${nix_cache_lb_ip}
        ports:
          ssh:
            port: 22
            targetPort: 22
            protocol: TCP
    persistence:
      nix:
        type: emptyDir
        medium: Memory
        advancedMounts:
          nixos-build:
            nix-seed:
              - path: /mnt/nix
            daemon:
              - path: /nix
            ssh-gateway:
              - path: /nix
      ssh-runtime:
        type: emptyDir
        advancedMounts:
          nixos-build:
            ssh-gateway:
              - path: /ssh
            ssh-perms:
              - path: /ssh
      nix-builds:
        type: emptyDir
        medium: Memory
        advancedMounts:
          nixos-build:
            daemon:
              - path: /nix/var/nix/builds
            nix-builds-perms:
              - path: /nix/var/nix/builds
      ssh-keys:
        type: secret
        name: nixos-build-ssh-keys
        defaultMode: 0600
        advancedMounts:
          nixos-build:
            ssh-gateway:
              - path: /ssh/authorized_keys
                subPath: authorized_keys
              - path: /ssh/ssh_host_rsa_key
                subPath: ssh_host_rsa_key
              - path: /ssh/ssh_host_ed25519_key
                subPath: ssh_host_ed25519_key
      cache-keys-dir:
        type: emptyDir
        advancedMounts:
          nixos-build:
            daemon:
              - path: /cache-keys
      cache-keys:
        type: secret
        name: nixos-build-cache-keys
        defaultMode: 0600
        advancedMounts:
          nixos-build:
            daemon:
              - path: /cache-keys/nix_cache_private.key
                subPath: nix_cache_private.key
              - path: /cache-keys/nix_cache_public.key
                subPath: nix_cache_public.key
            ssh-gateway:
              - path: /cache-keys/nix_cache_private.key
                subPath: nix_cache_private.key
              - path: /cache-keys/nix_cache_public.key
                subPath: nix_cache_public.key
