FROM nixos/nix:latest

ARG SOURCE_REPO="unknown"

LABEL org.opencontainers.image.title="nixos-build-daemon"
LABEL org.opencontainers.image.description="Nix build daemon container for remote builds."
LABEL org.opencontainers.image.source="${SOURCE_REPO}"

RUN nix --version \
    && nix-env -iA nixpkgs.openssh nixpkgs.nix-serve \
    && mkdir -p /etc/nix /nix/var/nix/daemon-socket /nix/var/nix/builds \
    && chown root:root /nix/var/nix/builds \
    && chmod 0755 /nix/var/nix/builds \
    && printf '%s\n' \
    'sandbox = true' \
    'build-users-group = nixbld' \
    'build-dir = /nix/var/nix/builds' \
    'sandbox-build-dir = /nix/var/nix/builds' \
    > /etc/nix/nix.conf

VOLUME ["/nix", "/nix/var/nix/daemon-socket"]

CMD ["/bin/sh", "-c", "exec nix-daemon --daemon"]
